<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üèÜ Thi ƒê·∫•u M√™ Cung Tri·∫øt H·ªçc</title>
    <link href="image/1.png" rel="icon" type="image/png">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
            background: linear-gradient(135deg, #1a0a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            color: #e8e8e8;
            overflow-x: hidden;
        }

        .stars {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
        }

        .star {
            position: absolute;
            width: 2px;
            height: 2px;
            background: white;
            border-radius: 50%;
            animation: twinkle 2s infinite;
        }

        @keyframes twinkle {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 1;
        }

        /* Header */
        .header {
            text-align: center;
            padding: 20px 0;
            border-bottom: 2px solid rgba(255, 215, 0, 0.3);
            margin-bottom: 30px;
        }

        .game-title {
            font-family: 'Cinzel', serif;
            font-size: 2.2rem;
            background: linear-gradient(45deg, #ffd700, #ff6b6b, #ffd700);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .nav-links {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 15px;
        }

        .nav-btn {
            padding: 10px 25px;
            border-radius: 25px;
            text-decoration: none;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            border: none;
            cursor: pointer;
        }

        .nav-btn.primary {
            background: linear-gradient(135deg, #4ade80, #22d3ee);
            color: #1a0a2e;
        }

        .nav-btn.secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .nav-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        }

        /* Screens */
        .screen {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .screen.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Menu Screen */
        .menu-screen {
            text-align: center;
            padding: 40px 20px;
        }

        .menu-icon {
            font-size: 5rem;
            margin-bottom: 30px;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-15px); }
        }

        .menu-description {
            font-size: 1.1rem;
            color: #a8a8a8;
            max-width: 500px;
            margin: 0 auto 40px;
            line-height: 1.8;
        }

        .menu-buttons {
            display: flex;
            flex-direction: column;
            gap: 20px;
            align-items: center;
        }

        .menu-btn {
            width: 300px;
            padding: 25px;
            font-size: 1.2rem;
            font-family: 'Cinzel', serif;
            border: 3px solid transparent;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .menu-btn.create {
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.2), rgba(245, 87, 108, 0.2));
            color: #fbbf24;
            border-color: rgba(251, 191, 36, 0.5);
        }

        .menu-btn.join {
            background: linear-gradient(135deg, rgba(74, 222, 128, 0.2), rgba(34, 211, 238, 0.2));
            color: #4ade80;
            border-color: rgba(74, 222, 128, 0.5);
        }

        .menu-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .menu-btn small {
            font-size: 0.8rem;
            color: #a8a8a8;
            font-family: 'Philosopher', serif;
        }

        /* Form Screen */
        .form-screen {
            max-width: 450px;
            margin: 0 auto;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 20px;
            padding: 35px;
            border: 1px solid rgba(255, 215, 0, 0.2);
        }

        .form-screen h2 {
            text-align: center;
            color: #ffd700;
            font-family: 'Cinzel', serif;
            margin-bottom: 30px;
            font-size: 1.5rem;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: #a8a8a8;
            font-size: 14px;
        }

        .input-group input {
            width: 100%;
            padding: 15px;
            font-size: 18px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            background: rgba(0, 0, 0, 0.4);
            color: #fff;
            outline: none;
            transition: border-color 0.3s;
        }

        .input-group input:focus {
            border-color: #8b5cf6;
        }

        .input-group input::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }

        .input-group input.code-input {
            text-transform: uppercase;
            text-align: center;
            letter-spacing: 8px;
            font-size: 28px;
            font-family: 'Cinzel', serif;
        }

        .btn {
            width: 100%;
            padding: 16px;
            font-size: 1.1rem;
            font-family: 'Cinzel', serif;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-primary {
            background: linear-gradient(90deg, #8b5cf6, #6366f1);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(139, 92, 246, 0.4);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .back-btn {
            background: none;
            border: none;
            color: #a8a8a8;
            cursor: pointer;
            font-size: 14px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: color 0.3s;
        }

        .back-btn:hover {
            color: #fff;
        }

        /* Room Display */
        .room-info {
            text-align: center;
            padding: 25px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 15px;
            margin: 20px 0;
            border: 1px solid rgba(139, 92, 246, 0.3);
        }

        .room-info small {
            color: #a8a8a8;
            font-size: 14px;
        }

        .room-code {
            font-size: 48px;
            font-weight: bold;
            color: #ffd700;
            letter-spacing: 10px;
            margin: 15px 0;
            font-family: 'Cinzel', serif;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }

        .room-name {
            font-size: 1.2rem;
            color: #8b5cf6;
            margin-bottom: 10px;
        }

        #qrcode {
            display: flex;
            justify-content: center;
            margin: 20px 0;
        }

        #qrcode canvas {
            border-radius: 10px;
            background: white;
            padding: 10px;
        }

        /* Player List */
        .player-section h3 {
            color: #a8a8a8;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .player-list {
            max-height: 250px;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            padding: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .player-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .player-item:last-child {
            border-bottom: none;
        }

        .player-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #8b5cf6, #6366f1);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 18px;
        }

        .player-name {
            flex: 1;
            color: #fff;
        }

        .host-badge {
            background: linear-gradient(45deg, #ffd700, #ff6b6b);
            color: #1a0a2e;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }

        .ready-badge {
            background: #4ade80;
            color: #1a0a2e;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 11px;
        }

        .waiting-text {
            text-align: center;
            color: #a8a8a8;
            padding: 20px;
            font-style: italic;
        }

        /* Progress */
        .progress-container {
            background: rgba(0, 0, 0, 0.4);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
            border: 1px solid rgba(255, 215, 0, 0.2);
        }

        .progress-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .room-counter {
            font-family: 'Cinzel', serif;
            font-size: 1.2rem;
            color: #ffd700;
        }

        .score-display {
            display: flex;
            gap: 15px;
        }

        .score-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
        }

        .score-item.correct { color: #4ade80; }
        .score-item.wrong { color: #f87171; }

        .timer-display {
            font-size: 1.5rem;
            font-weight: bold;
            color: #fbbf24;
            font-family: 'Cinzel', serif;
        }

        .progress-bar {
            height: 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4ade80, #22d3ee, #818cf8);
            border-radius: 6px;
            transition: width 0.5s ease;
        }

        /* Cards */
        .cards-area {
            margin-bottom: 30px;
        }

        .cards-instruction {
            text-align: center;
            font-size: 1.2rem;
            color: #fbbf24;
            margin-bottom: 20px;
            font-style: italic;
        }

        .cards-container {
            display: flex;
            justify-content: center;
            gap: 25px;
            flex-wrap: wrap;
            perspective: 1000px;
        }

        .card {
            width: 180px;
            height: 250px;
            position: relative;
            cursor: pointer;
            transition: transform 0.3s ease;
            transform-style: preserve-3d;
        }

        .card:hover:not(.flipped):not(.disabled) {
            transform: translateY(-10px) scale(1.02);
        }

        .card.flipped {
            transform: rotateY(180deg);
        }

        .card.disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }

        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 15px;
            backface-visibility: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .card-back {
            background: linear-gradient(145deg, #2d1b4e, #1a0a2e);
            border: 3px solid #8b5cf6;
        }

        .card-back::before {
            content: '?';
            font-size: 4rem;
            color: #8b5cf6;
            font-family: 'Cinzel', serif;
        }

        .card-front {
            background: linear-gradient(145deg, #1e3a5f, #16213e);
            border: 3px solid #22d3ee;
            transform: rotateY(180deg);
        }

        .card-front.bomb-card {
            background: linear-gradient(145deg, #4a1c1c, #2d0a0a);
            border-color: #ef4444;
        }

        .card-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }

        .card-topic {
            font-size: 0.95rem;
            text-align: center;
            font-weight: 600;
        }

        .bomb-card .card-icon {
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        /* Lockout Overlay */
        .lockout-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 100;
            flex-direction: column;
        }

        .lockout-overlay.active {
            display: flex;
        }

        .lockout-icon {
            font-size: 6rem;
            margin-bottom: 20px;
        }

        .lockout-message {
            font-size: 1.5rem;
            color: #f87171;
            margin-bottom: 20px;
        }

        .lockout-timer {
            font-size: 4rem;
            font-family: 'Cinzel', serif;
            color: #fbbf24;
        }

        /* Question Area */
        .question-area {
            background: rgba(0, 0, 0, 0.4);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 215, 0, 0.2);
            display: none;
        }

        .question-area.active {
            display: block;
            animation: slideIn 0.5s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .question-topic {
            background: linear-gradient(90deg, #8b5cf6, #6366f1);
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 0.9rem;
        }

        .question-text {
            font-size: 1.2rem;
            line-height: 1.8;
            margin-bottom: 25px;
        }

        .answers-grid {
            display: grid;
            gap: 12px;
        }

        .answer-option {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 16px 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: flex-start;
            gap: 15px;
        }

        .answer-option:hover:not(.disabled) {
            background: rgba(255, 255, 255, 0.1);
            border-color: #8b5cf6;
        }

        .answer-option.selected {
            border-color: #fbbf24;
            background: rgba(251, 191, 36, 0.1);
        }

        .answer-option.correct {
            border-color: #4ade80;
            background: rgba(74, 222, 128, 0.2);
        }

        .answer-option.wrong {
            border-color: #f87171;
            background: rgba(248, 113, 113, 0.2);
        }

        .answer-option.disabled {
            cursor: not-allowed;
            opacity: 0.7;
        }

        .answer-label {
            background: rgba(255, 255, 255, 0.1);
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            flex-shrink: 0;
        }

        .submit-btn {
            width: 100%;
            padding: 18px;
            margin-top: 25px;
            font-size: 1.1rem;
            font-family: 'Cinzel', serif;
            background: linear-gradient(90deg, #8b5cf6, #6366f1);
            border: none;
            border-radius: 12px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
        }

        .submit-btn:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(139, 92, 246, 0.4);
        }

        .submit-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .submit-btn.next-room {
            background: linear-gradient(90deg, #4ade80, #22d3ee);
        }

        /* Rankings */
        .rankings-screen {
            text-align: center;
        }

        .rankings-title {
            font-family: 'Cinzel', serif;
            font-size: 2rem;
            color: #ffd700;
            margin-bottom: 30px;
        }

        .podium {
            display: flex;
            justify-content: center;
            align-items: flex-end;
            gap: 15px;
            margin: 30px 0;
        }

        .podium-place {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .podium-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #8b5cf6, #6366f1);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
            border: 3px solid rgba(255, 255, 255, 0.3);
        }

        .podium-name {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .podium-stats {
            font-size: 12px;
            color: #a8a8a8;
        }

        .podium-block {
            width: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 28px;
            font-weight: bold;
            border-radius: 10px 10px 0 0;
            margin-top: 10px;
            font-family: 'Cinzel', serif;
        }

        .place-1 .podium-block {
            height: 100px;
            background: linear-gradient(135deg, #ffd700, #ff6b6b);
        }
        .place-1 .podium-avatar { border-color: #ffd700; }

        .place-2 .podium-block {
            height: 70px;
            background: linear-gradient(135deg, #c0c0c0, #808080);
        }

        .place-3 .podium-block {
            height: 50px;
            background: linear-gradient(135deg, #cd7f32, #8b4513);
        }

        .full-rankings {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            padding: 10px;
            margin-top: 20px;
            text-align: left;
        }

        .rank-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            gap: 15px;
        }

        .rank-item:last-child {
            border-bottom: none;
        }

        .rank-number {
            width: 30px;
            font-weight: bold;
            color: #ffd700;
        }

        .rank-score {
            color: #4ade80;
            font-weight: bold;
        }

        .rank-time {
            color: #a8a8a8;
            font-size: 14px;
        }

        /* Loading */
        .loading-spinner {
            display: none;
            justify-content: center;
            padding: 30px;
        }

        .loading-spinner.active {
            display: flex;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 215, 0, 0.2);
            border-top-color: #ffd700;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Toast Notifications - Left of chatbot icon */
        .toast-container {
            position: fixed;
            bottom: 25px;
            right: 90px;
            z-index: 999;
            display: flex;
            flex-direction: column-reverse;
            gap: 10px;
            pointer-events: none;
        }

        .toast {
            background: rgba(26, 10, 46, 0.95);
            border: 1px solid rgba(139, 92, 246, 0.5);
            border-radius: 12px;
            padding: 12px 20px;
            color: #e8e8e8;
            animation: toastIn 0.3s ease, toastOut 0.5s ease 3s forwards;
        }

        .toast.success { border-left: 4px solid #4ade80; }
        .toast.error { border-left: 4px solid #f87171; }
        .toast.info { border-left: 4px solid #8b5cf6; }

        .toast-message {
            background: rgba(26, 10, 46, 0.95);
            border: 1px solid rgba(139, 92, 246, 0.5);
            border-radius: 12px;
            padding: 12px 16px;
            max-width: 280px;
            color: #e8e8e8;
            font-size: 0.9rem;
            line-height: 1.5;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(10px);
            animation: toastSlideIn 0.3s ease, toastFadeOut 0.5s ease 3.5s forwards;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .toast-message .toast-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .toast-message .toast-content {
            flex: 1;
        }

        @keyframes toastIn {
            from { opacity: 0; transform: translateX(50px); }
            to { opacity: 1; transform: translateX(0); }
        }

        @keyframes toastOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }

        @keyframes toastSlideIn {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        @keyframes toastFadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .game-title { font-size: 1.6rem; }
            .card { width: 140px; height: 200px; }
            .room-code { font-size: 36px; letter-spacing: 5px; }
            .podium-block { width: 60px; }
        }

        .hidden { display: none !important; }

        /* Floating Chatbot - Bottom Right */
        .chatbot-float {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }

        .chatbot-toggle {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #8b5cf6, #6366f1);
            border: 3px solid #ffd700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 20px rgba(139, 92, 246, 0.5);
            transition: all 0.3s ease;
            overflow: hidden;
            position: relative;
        }

        .chatbot-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 30px rgba(139, 92, 246, 0.7);
        }

        .chatbot-toggle img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        .chatbot-toggle .notification-dot {
            position: absolute;
            top: 0;
            right: 0;
            width: 16px;
            height: 16px;
            background: #ef4444;
            border-radius: 50%;
            border: 2px solid #1a0a2e;
            animation: pulse-dot 1.5s infinite;
            display: none;
        }

        .chatbot-toggle .notification-dot.active {
            display: block;
        }

        @keyframes pulse-dot {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        .chatbot-window {
            position: absolute;
            bottom: 70px;
            right: 0;
            width: 320px;
            max-height: 400px;
            background: rgba(26, 10, 46, 0.95);
            border-radius: 16px;
            border: 1px solid rgba(139, 92, 246, 0.5);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            display: none;
            flex-direction: column;
            overflow: hidden;
            backdrop-filter: blur(10px);
        }

        .chatbot-window.open {
            display: flex;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .chatbot-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 15px;
            background: linear-gradient(90deg, rgba(139, 92, 246, 0.3), rgba(99, 102, 241, 0.3));
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .chatbot-header img {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 2px solid #ffd700;
        }

        .chatbot-header-info {
            flex: 1;
        }

        .chatbot-name {
            font-size: 1rem;
            color: #ffd700;
        }

        .chatbot-status {
            font-size: 0.75rem;
            color: #4ade80;
        }

        .chatbot-close {
            background: none;
            border: none;
            color: #a8a8a8;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 5px;
            transition: color 0.2s;
        }

        .chatbot-close:hover {
            color: #fff;
        }

        .chat-messages {
            flex: 1;
            max-height: 300px;
            overflow-y: auto;
            padding: 15px;
        }

        .chat-messages::-webkit-scrollbar {
            width: 5px;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: #8b5cf6;
            border-radius: 3px;
        }

        .chat-message {
            display: flex;
            gap: 10px;
            margin-bottom: 12px;
        }

        .chat-message .avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            object-fit: cover;
            flex-shrink: 0;
        }

        .chat-message .content {
            background: rgba(139, 92, 246, 0.2);
            padding: 10px 12px;
            border-radius: 12px;
            border-top-left-radius: 4px;
            line-height: 1.5;
            font-size: 0.9rem;
            max-width: 230px;
            color: #e8e8e8;
        }
    </style>
</head>
<body>
    <div class="stars" id="stars"></div>

    <!-- Lockout Overlay -->
    <div class="lockout-overlay" id="lockoutOverlay">
        <div class="lockout-icon" id="lockoutIcon">üí£</div>
        <div class="lockout-message" id="lockoutMessage">B·∫°n ƒë√£ ch·ªçn ph·∫£i bom!</div>
        <div class="lockout-timer" id="lockoutTimer">10</div>
    </div>

    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1 class="game-title">üèÜ Thi ƒê·∫•u M√™ Cung Tri·∫øt H·ªçc</h1>
            <div class="nav-links" id="navLinks">
                <a href="../luyentap/" class="nav-btn primary">üìö Luy·ªán T·∫≠p</a>
                <a href="../" class="nav-btn secondary">üí¨ Chatbot</a>
            </div>
        </div>

        <!-- Menu Screen -->
        <div class="screen active" id="menuScreen">
            <div class="menu-screen">
                <div class="menu-icon">üèÜ</div>
                <p class="menu-description">
                    Thi ƒë·∫•u c√πng b·∫°n b√®! T·∫°o ph√≤ng v√† m·ªùi m·ªçi ng∆∞·ªùi tham gia.
                    <br>Ai tr·∫£ l·ªùi ƒë√∫ng 10 c√¢u nhanh nh·∫•t s·∫Ω chi·∫øn th·∫Øng!
                </p>
                <div class="menu-buttons">
                    <button class="menu-btn create" onclick="showCreateRoom()">
                        <span>üéÆ T·∫°o Ph√≤ng</span>
                        <small>T·∫°o ph√≤ng m·ªõi ƒë·ªÉ b·∫°n b√® tham gia</small>
                    </button>
                    <button class="menu-btn join" onclick="showJoinRoom()">
                        <span>üö™ V√†o Ph√≤ng</span>
                        <small>Nh·∫≠p m√£ ph√≤ng ƒë·ªÉ tham gia</small>
                    </button>
                </div>
            </div>
        </div>

        <!-- Create Room Screen -->
        <div class="screen" id="createRoomScreen">
            <div class="form-screen">
                <button class="back-btn" onclick="showMenu()">‚Üê Quay l·∫°i</button>
                <h2>üéÆ T·∫°o Ph√≤ng M·ªõi</h2>
                <div class="input-group">
                    <label>T√™n ph√≤ng</label>
                    <input type="text" id="roomNameInput" placeholder="VD: Ph√≤ng Tri·∫øt H·ªçc A1" maxlength="30">
                </div>
                <div class="input-group">
                    <label>T√™n c·ªßa b·∫°n (Ch·ªß ph√≤ng)</label>
                    <input type="text" id="hostNameInput" placeholder="Nh·∫≠p t√™n c·ªßa b·∫°n..." maxlength="20">
                </div>
                <button class="btn btn-primary" onclick="createRoom()">T·∫°o Ph√≤ng</button>
            </div>
        </div>

        <!-- Join Room Screen (Step 1: Enter Code) -->
        <div class="screen" id="joinRoomScreen">
            <div class="form-screen">
                <button class="back-btn" onclick="showMenu()">‚Üê Quay l·∫°i</button>
                <h2>üö™ V√†o Ph√≤ng</h2>
                <div class="input-group">
                    <label>Nh·∫≠p m√£ ph√≤ng (6 k√Ω t·ª±)</label>
                    <input type="text" id="joinCodeInput" class="code-input" placeholder="XXXXXX" maxlength="6">
                </div>
                <button class="btn btn-primary" onclick="checkRoom()">Ki·ªÉm Tra Ph√≤ng</button>
            </div>
        </div>

        <!-- Join Room Screen (Step 2: Enter Name) -->
        <div class="screen" id="enterNameScreen">
            <div class="form-screen">
                <button class="back-btn" onclick="showJoinRoom()">‚Üê Quay l·∫°i</button>
                <h2>‚úÖ T√¨m Th·∫•y Ph√≤ng!</h2>
                <div class="room-info">
                    <div class="room-name" id="foundRoomName">T√™n ph√≤ng</div>
                    <small>M√£ ph√≤ng</small>
                    <div class="room-code" id="foundRoomCode">XXXXXX</div>
                </div>
                <div class="input-group">
                    <label>Nh·∫≠p t√™n c·ªßa b·∫°n ƒë·ªÉ tham gia</label>
                    <input type="text" id="playerNameInput" placeholder="Nh·∫≠p t√™n c·ªßa b·∫°n..." maxlength="20">
                </div>
                <button class="btn btn-primary" onclick="joinRoom()">V√†o Ph√≤ng</button>
            </div>
        </div>

        <!-- Waiting Room (Host) -->
        <div class="screen" id="waitingHostScreen">
            <div class="form-screen" style="max-width: 550px;">
                <h2>‚è≥ Ph√≤ng Ch·ªù</h2>
                <div class="room-info">
                    <div class="room-name" id="waitingRoomName">T√™n ph√≤ng</div>
                    <small>M√£ ph√≤ng - Chia s·∫ª cho b·∫°n b√®!</small>
                    <div class="room-code" id="waitingRoomCode">------</div>
                    <div id="qrcode"></div>
                </div>
                <div class="player-section">
                    <h3>üë• Ng∆∞·ªùi ch∆°i (<span id="playerCount">0</span>)</h3>
                    <div class="player-list" id="playerList"></div>
                </div>
                <button class="btn btn-primary" id="startGameBtn" onclick="startCompetition()" disabled>
                    B·∫Øt ƒê·∫ßu Thi ƒê·∫•u
                </button>
            </div>
        </div>

        <!-- Waiting Room (Player) -->
        <div class="screen" id="waitingPlayerScreen">
            <div class="form-screen" style="max-width: 550px;">
                <h2>‚è≥ ƒêang Ch·ªù...</h2>
                <div class="room-info">
                    <div class="room-name" id="waitingRoomNamePlayer">T√™n ph√≤ng</div>
                    <small>M√£ ph√≤ng</small>
                    <div class="room-code" id="waitingRoomCodePlayer">------</div>
                </div>
                <p class="waiting-text">ƒêang ch·ªù ch·ªß ph√≤ng b·∫Øt ƒë·∫ßu tr·∫≠n ƒë·∫•u...</p>
                <div class="player-section">
                    <h3>üë• Ng∆∞·ªùi ch∆°i (<span id="playerCountPlayer">0</span>)</h3>
                    <div class="player-list" id="playerListPlayer"></div>
                </div>
            </div>
        </div>

        <!-- Game Screen -->
        <div class="screen" id="gameScreen">
            <div class="progress-container">
                <div class="progress-info">
                    <span class="room-counter">üö™ Ph√≤ng <span id="roomNumber">1</span></span>
                    <div class="score-display">
                        <span class="score-item correct">‚úì <span id="correctCount">0</span></span>
                        <span class="score-item wrong">‚úó <span id="wrongCount">0</span></span>
                    </div>
                    <div class="timer-display" id="timer">00:00</div>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                </div>
            </div>

            <div class="cards-area" id="cardsArea">
                <p class="cards-instruction">üé¥ Ch·ªçn m·ªôt l√° b√†i ƒë·ªÉ l·∫≠t...</p>
                <div class="cards-container" id="cardsContainer"></div>
            </div>

            <div class="loading-spinner" id="loadingSpinner">
                <div class="spinner"></div>
            </div>

            <div class="question-area" id="questionArea">
                <div class="question-header">
                    <span class="question-topic" id="questionTopic">Ch·ªß ƒë·ªÅ</span>
                    <span id="questionNumber">C√¢u 1/10</span>
                </div>
                <p class="question-text" id="questionText">ƒêang t·∫£i c√¢u h·ªèi...</p>
                <div class="answers-grid" id="answersGrid"></div>
                <button class="submit-btn" id="submitBtn" onclick="submitAnswer()" disabled>X√°c Nh·∫≠n</button>
            </div>
        </div>

        <!-- Rankings Screen -->
        <div class="screen" id="rankingsScreen">
            <div class="rankings-screen">
                <h2 class="rankings-title">üèÜ B·∫£ng X·∫øp H·∫°ng</h2>
                <div class="podium" id="podium"></div>
                <div class="full-rankings" id="fullRankings"></div>
                <button class="btn btn-primary" onclick="backToMenu()" style="margin-top: 30px;">
                    V·ªÅ Trang Ch·ªß
                </button>
            </div>
        </div>
    </div>

    <!-- Floating Chatbot - Bottom Right -->
    <div class="chatbot-float" id="chatbotFloat">
        <div class="chatbot-window" id="chatbotWindow">
            <div class="chatbot-header">
                <img src="image/1.png" alt="AI" onerror="this.src='https://api.dicebear.com/7.x/bottts/svg?seed=philosophy'">
                <div class="chatbot-header-info">
                    <div class="chatbot-name">Tri·∫øt h·ªçc AI</div>
                    <div class="chatbot-status">‚óè ƒêang h·ªó tr·ª£</div>
                </div>
                <button class="chatbot-close" onclick="toggleChatbot()">‚úï</button>
            </div>
            <div class="chat-messages" id="chatMessages">
                <div class="chat-message">
                    <img src="image/1.png" alt="AI" class="avatar" onerror="this.src='https://api.dicebear.com/7.x/bottts/svg?seed=philosophy'">
                    <div class="content">
                        Ch√†o b·∫°n! T√¥i l√† Tri·∫øt h·ªçc AI. H√£y l·∫≠t m·ªôt l√° b√†i ƒë·ªÉ b·∫Øt ƒë·∫ßu. N·∫øu tr·∫£ l·ªùi sai, t√¥i s·∫Ω g·ª£i √Ω ƒë·ªÉ gi√∫p b·∫°n! üé¥
                    </div>
                </div>
            </div>
        </div>
        <div class="chatbot-toggle" onclick="toggleChatbot()">
            <img src="image/1.png" alt="AI" onerror="this.src='https://api.dicebear.com/7.x/bottts/svg?seed=philosophy'">
            <span class="notification-dot" id="notificationDot"></span>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <script>
        const API_BASE = 'https://posts-teeth-brook-depot.trycloudflare.com';

        const topics = [
            { name: 'V·∫≠t ch·∫•t & √ù th·ª©c', icon: 'üß†' },
            { name: 'Ngu·ªìn g·ªëc & b·∫£n ch·∫•t nh·∫≠n th·ª©c', icon: 'üëÅÔ∏è' },
            { name: 'Ch√¢n l√Ω', icon: '‚ú®' },
            { name: 'C√°c quy lu·∫≠t bi·ªán ch·ª©ng', icon: 'üîÑ' },
            { name: 'Ph·∫°m tr√π ph√©p bi·ªán ch·ª©ng', icon: 'üìä' },
            { name: 'X√£ h·ªôi, giai c·∫•p, nh√† n∆∞·ªõc', icon: 'üèõÔ∏è' }
        ];

        let gameState = {
            roomCode: null,
            roomName: null,
            playerName: null,
            isHost: false,
            sessionId: null,
            roomNumber: 1,
            correctCount: 0,
            wrongCount: 0,
            currentQuestion: null,
            selectedAnswer: null,
            isLocked: false,
            startTime: null,
            timerInterval: null,
            pollInterval: null,
            requiredCorrect: 10
        };

        // Generate stars
        function generateStars() {
            const container = document.getElementById('stars');
            for (let i = 0; i < 100; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                star.style.left = Math.random() * 100 + '%';
                star.style.top = Math.random() * 100 + '%';
                star.style.animationDelay = Math.random() * 2 + 's';
                container.appendChild(star);
            }
        }

        // Navigation
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }

        function showMenu() {
            clearIntervals();
            showScreen('menuScreen');
        }

        function showCreateRoom() {
            showScreen('createRoomScreen');
        }

        function showJoinRoom() {
            showScreen('joinRoomScreen');
            document.getElementById('joinCodeInput').value = '';
        }

        function backToMenu() {
            clearIntervals();
            resetGameState();
            // Hi·ªán l·∫°i nav-links khi quay v·ªÅ menu
            document.getElementById('navLinks').classList.remove('hidden');
            showScreen('menuScreen');
        }

        function clearIntervals() {
            if (gameState.timerInterval) clearInterval(gameState.timerInterval);
            if (gameState.pollInterval) clearInterval(gameState.pollInterval);
        }

        function resetGameState() {
            gameState = {
                roomCode: null,
                roomName: null,
                playerName: null,
                isHost: false,
                sessionId: null,
                roomNumber: 1,
                correctCount: 0,
                wrongCount: 0,
                currentQuestion: null,
                selectedAnswer: null,
                isLocked: false,
                startTime: null,
                timerInterval: null,
                pollInterval: null,
                requiredCorrect: 10
            };
        }

        // Toast
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3500);
        }

        // Chatbot toggle (gi·ªëng maze-game.html)
        function toggleChatbot() {
            const chatWindow = document.getElementById('chatbotWindow');
            const notificationDot = document.getElementById('notificationDot');
            
            chatWindow.classList.toggle('open');
            
            // Clear notification dot when opening
            if (chatWindow.classList.contains('open')) {
                notificationDot.classList.remove('active');
            }
        }

        // Show Toast Notification (left of chatbot icon) - gi·ªëng maze-game.html
        function showChatToast(message) {
            const toastContainer = document.getElementById('toastContainer');
            
            const toast = document.createElement('div');
            toast.className = 'toast-message';
            const plainText = message.replace(/<[^>]*>/g, '');
            toast.innerHTML = `
                <img src="image/1.png" alt="AI" class="toast-avatar" onerror="this.src='https://api.dicebear.com/7.x/bottts/svg?seed=philosophy'">
                <div class="toast-content">${plainText}</div>
            `;
            
            toastContainer.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 4000);
        }

        // Add message to chatbot + show toast (gi·ªëng maze-game.html)
        function addChatMessage(message) {
            const chatMessages = document.getElementById('chatMessages');
            const chatWindow = document.getElementById('chatbotWindow');
            const notificationDot = document.getElementById('notificationDot');
            
            const div = document.createElement('div');
            div.className = 'chat-message';
            div.innerHTML = `
                <img src="image/1.png" alt="AI" class="avatar" onerror="this.src='https://api.dicebear.com/7.x/bottts/svg?seed=philosophy'">
                <div class="content">${message}</div>
            `;
            chatMessages.appendChild(div);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // Show notification dot if chat window is closed
            if (!chatWindow.classList.contains('open')) {
                notificationDot.classList.add('active');
                // Also show toast notification
                showChatToast(message);
            }
        }

        // Create Room
        async function createRoom() {
            const roomName = document.getElementById('roomNameInput').value.trim();
            const hostName = document.getElementById('hostNameInput').value.trim();

            if (!roomName) {
                showToast('Vui l√≤ng nh·∫≠p t√™n ph√≤ng!', 'error');
                return;
            }
            if (!hostName) {
                showToast('Vui l√≤ng nh·∫≠p t√™n c·ªßa b·∫°n!', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/competition/create`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        host_name: hostName,
                        room_name: roomName
                    })
                });

                const data = await response.json();
                if (!response.ok) throw new Error(data.message || 'Kh√¥ng th·ªÉ t·∫°o ph√≤ng');

                gameState.roomCode = data.room_code;
                gameState.roomName = roomName;
                gameState.playerName = hostName;
                gameState.isHost = true;

                showWaitingHost();
                showToast('T·∫°o ph√≤ng th√†nh c√¥ng!', 'success');
            } catch (error) {
                showToast('L·ªói: ' + error.message, 'error');
            }
        }

        function showWaitingHost() {
            showScreen('waitingHostScreen');
            document.getElementById('waitingRoomName').textContent = gameState.roomName;
            document.getElementById('waitingRoomCode').textContent = gameState.roomCode;

            // Generate QR
            const qrContainer = document.getElementById('qrcode');
            qrContainer.innerHTML = '';
            new QRCode(qrContainer, {
                text: `${window.location.origin}${window.location.pathname}?join=${gameState.roomCode}`,
                width: 150,
                height: 150
            });

            pollRoomStatus();
        }

        // Check Room (Step 1)
        async function checkRoom() {
            const code = document.getElementById('joinCodeInput').value.trim().toUpperCase();

            if (!code || code.length !== 6) {
                showToast('M√£ ph√≤ng ph·∫£i c√≥ 6 k√Ω t·ª±!', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/competition/room/${code}`);
                const data = await response.json();

                if (!response.ok) throw new Error(data.message || 'Ph√≤ng kh√¥ng t·ªìn t·∫°i');

                gameState.roomCode = code;
                gameState.roomName = data.room_name || 'Ph√≤ng Thi ƒê·∫•u';

                document.getElementById('foundRoomName').textContent = gameState.roomName;
                document.getElementById('foundRoomCode').textContent = code;

                showScreen('enterNameScreen');
            } catch (error) {
                showToast('L·ªói: ' + error.message, 'error');
            }
        }

        // Join Room (Step 2)
        async function joinRoom() {
            const playerName = document.getElementById('playerNameInput').value.trim();

            if (!playerName) {
                showToast('Vui l√≤ng nh·∫≠p t√™n c·ªßa b·∫°n!', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/competition/join`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        room_code: gameState.roomCode,
                        player_name: playerName
                    })
                });

                const data = await response.json();
                if (!response.ok) throw new Error(data.message || 'Kh√¥ng th·ªÉ tham gia ph√≤ng');

                gameState.playerName = playerName;
                gameState.isHost = false;

                showWaitingPlayer();
                showToast('ƒê√£ v√†o ph√≤ng!', 'success');
            } catch (error) {
                showToast('L·ªói: ' + error.message, 'error');
            }
        }

        function showWaitingPlayer() {
            showScreen('waitingPlayerScreen');
            document.getElementById('waitingRoomNamePlayer').textContent = gameState.roomName;
            document.getElementById('waitingRoomCodePlayer').textContent = gameState.roomCode;

            pollRoomStatus();
        }

        // Poll Room Status
        async function pollRoomStatus() {
            const update = async () => {
                try {
                    const response = await fetch(`${API_BASE}/api/competition/room/${gameState.roomCode}`);
                    const data = await response.json();

                    if (!response.ok) {
                        showToast('Ph√≤ng kh√¥ng t·ªìn t·∫°i', 'error');
                        clearIntervals();
                        backToMenu();
                        return;
                    }

                    // Update player list
                    const listEl = gameState.isHost ? 
                        document.getElementById('playerList') : 
                        document.getElementById('playerListPlayer');
                    const countEl = gameState.isHost ? 
                        document.getElementById('playerCount') : 
                        document.getElementById('playerCountPlayer');

                    countEl.textContent = data.players.length;
                    listEl.innerHTML = data.players.map(p => `
                        <div class="player-item">
                            <div class="player-avatar">${p.name.charAt(0).toUpperCase()}</div>
                            <span class="player-name">${p.name}</span>
                            ${p.is_host ? '<span class="host-badge">Ch·ªß ph√≤ng</span>' : ''}
                        </div>
                    `).join('');

                    if (gameState.isHost) {
                        document.getElementById('startGameBtn').disabled = data.players.length < 1;
                    }

                    // Check if game started (for players)
                    if (!gameState.isHost && data.room_status === 'playing') {
                        clearInterval(gameState.pollInterval);
                        initGame();
                    }
                } catch (error) {
                    console.error('Poll error:', error);
                }
            };

            update();
            gameState.pollInterval = setInterval(update, 2000);
        }

        // Start Competition (Host only)
        async function startCompetition() {
            try {
                const response = await fetch(`${API_BASE}/api/competition/start`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        room_code: gameState.roomCode,
                        host_name: gameState.playerName
                    })
                });

                const data = await response.json();
                if (!response.ok) throw new Error(data.message || 'Kh√¥ng th·ªÉ b·∫Øt ƒë·∫ßu');

                clearInterval(gameState.pollInterval);
                initGame();
            } catch (error) {
                showToast('L·ªói: ' + error.message, 'error');
            }
        }

        // Initialize Game
        async function initGame() {
            try {
                const response = await fetch(`${API_BASE}/api/game/maze/start`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });

                const data = await response.json();
                gameState.sessionId = data.session_id;
                gameState.requiredCorrect = data.rooms_total || 10;

                gameState.startTime = Date.now();
                gameState.timerInterval = setInterval(updateTimer, 1000);

                // ·∫®n nav-links khi v√†o game
                document.getElementById('navLinks').classList.add('hidden');

                showScreen('gameScreen');
                generateCards();
                addChatMessage('Tr·∫≠n ƒë·∫•u b·∫Øt ƒë·∫ßu! H√£y l·∫≠t b√†i v√† tr·∫£ l·ªùi nhanh nh·∫•t c√≥ th·ªÉ! ‚ö°');
            } catch (error) {
                showToast('L·ªói: ' + error.message, 'error');
            }
        }

        function updateTimer() {
            const elapsed = Math.floor((Date.now() - gameState.startTime) / 1000);
            const mins = Math.floor(elapsed / 60);
            const secs = elapsed % 60;
            document.getElementById('timer').textContent = 
                `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        // Generate Cards
        function generateCards() {
            const container = document.getElementById('cardsContainer');
            container.innerHTML = '';

            const shuffled = [...topics].sort(() => Math.random() - 0.5);
            const selected = shuffled.slice(0, 2);

            const cardData = [
                { type: 'topic', ...selected[0] },
                { type: 'topic', ...selected[1] },
                { type: 'bomb', name: 'BOM!', icon: 'üí£' }
            ].sort(() => Math.random() - 0.5);

            cardData.forEach((data, i) => {
                const card = document.createElement('div');
                card.className = 'card';
                card.dataset.type = data.type;
                card.dataset.topic = data.name;
                card.onclick = () => flipCard(card);

                card.innerHTML = `
                    <div class="card-face card-back"></div>
                    <div class="card-face card-front ${data.type === 'bomb' ? 'bomb-card' : ''}">
                        <div class="card-icon">${data.icon}</div>
                        <div class="card-topic">${data.name}</div>
                    </div>
                `;

                container.appendChild(card);
            });
        }

        // Flip Card
        async function flipCard(card) {
            if (gameState.isLocked || card.classList.contains('flipped') || card.classList.contains('disabled')) {
                return;
            }

            card.classList.add('flipped');

            const cardType = card.dataset.type;
            const topic = card.dataset.topic;
            const icon = card.dataset.icon;

            if (cardType === 'bomb') {
                setTimeout(() => {
                    document.querySelectorAll('.card').forEach(c => c.classList.add('disabled'));
                    addChatMessage(`üí£ √îi kh√¥ng! B·∫°n ƒë√£ l·∫≠t ph·∫£i l√° BOM! ƒê·ª£i 10 gi√¢y r·ªìi ch·ªçn l√° kh√°c nh√©!`);
                    showLockout('bomb');
                }, 600);
            } else {
                setTimeout(async () => {
                    document.querySelectorAll('.card').forEach(c => c.classList.add('disabled'));
                    addChatMessage(`${icon} B·∫°n ƒë√£ ch·ªçn ch·ªß ƒë·ªÅ: <strong>${topic}</strong>. ƒêang t·∫£i c√¢u h·ªèi...`);
                    await fetchQuestion(topic);
                }, 600);
            }
        }

        // Lockout
        function showLockout(type, message = null) {
            gameState.isLocked = true;
            const overlay = document.getElementById('lockoutOverlay');
            const icon = document.getElementById('lockoutIcon');
            const msg = document.getElementById('lockoutMessage');
            const timer = document.getElementById('lockoutTimer');

            icon.textContent = type === 'bomb' ? 'üí£' : '‚ùå';
            msg.textContent = type === 'bomb' ? 'B·∫°n ƒë√£ ch·ªçn ph·∫£i bom!' : (message || 'ƒê√°p √°n ch∆∞a ƒë√∫ng!');

            overlay.classList.add('active');
            let seconds = 10;
            timer.textContent = seconds;

            const countdown = setInterval(() => {
                seconds--;
                timer.textContent = seconds;
                if (seconds <= 0) {
                    clearInterval(countdown);
                    overlay.classList.remove('active');
                    gameState.isLocked = false;

                    if (type === 'bomb') {
                        document.querySelectorAll('.card').forEach(c => {
                            if (c.dataset.type !== 'bomb') c.classList.remove('disabled');
                        });
                    }
                }
            }, 1000);
        }

        // Fetch Question
        async function fetchQuestion(topic) {
            document.getElementById('cardsArea').style.display = 'none';
            document.getElementById('loadingSpinner').classList.add('active');

            try {
                const response = await fetch(`${API_BASE}/api/game/maze/question`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: gameState.sessionId,
                        topic: topic
                    })
                });

                const data = await response.json();

                if (data.status === 'ok' || data.question) {
                    gameState.currentQuestion = data;
                    displayQuestion(data, topic);
                } else {
                    addChatMessage('Kh√¥ng t√¨m th·∫•y c√¢u h·ªèi cho ch·ªß ƒë·ªÅ n√†y. H√£y th·ª≠ ch·ªß ƒë·ªÅ kh√°c! üîç');
                    resetToCards();
                }
            } catch (error) {
                addChatMessage('C√≥ l·ªói x·∫£y ra. H√£y th·ª≠ l·∫°i nh√©! üîß');
                resetToCards();
            }
        }

        function displayQuestion(data, topic) {
            document.getElementById('loadingSpinner').classList.remove('active');

            document.getElementById('questionTopic').textContent = topic;
            document.getElementById('questionNumber').textContent = `C√¢u ${gameState.correctCount + 1}/${gameState.requiredCorrect}`;
            document.getElementById('questionText').textContent = data.question;

            const grid = document.getElementById('answersGrid');
            grid.innerHTML = '';

            ['A', 'B', 'C', 'D'].forEach(opt => {
                if (data[opt]) {
                    const div = document.createElement('div');
                    div.className = 'answer-option';
                    div.dataset.answer = opt;
                    div.onclick = () => selectAnswer(opt);
                    div.innerHTML = `
                        <span class="answer-label">${opt}</span>
                        <span>${data[opt]}</span>
                    `;
                    grid.appendChild(div);
                }
            });

            gameState.selectedAnswer = null;
            document.getElementById('submitBtn').disabled = true;
            document.getElementById('questionArea').classList.add('active');
        }

        function selectAnswer(answer) {
            if (gameState.isLocked) return;

            document.querySelectorAll('.answer-option').forEach(o => o.classList.remove('selected'));
            document.querySelector(`.answer-option[data-answer="${answer}"]`).classList.add('selected');
            gameState.selectedAnswer = answer;
            document.getElementById('submitBtn').disabled = false;
        }

        // Submit Answer
        async function submitAnswer() {
            if (!gameState.selectedAnswer || gameState.isLocked) return;

            const btn = document.getElementById('submitBtn');

            if (btn.dataset.nextRoom === 'true') {
                gameState.roomNumber++;
                nextRoom();
                return;
            }

            btn.disabled = true;
            btn.textContent = 'ƒêang ki·ªÉm tra...';
            document.querySelectorAll('.answer-option').forEach(o => o.classList.add('disabled'));

            try {
                const response = await fetch(`${API_BASE}/api/game/maze/answer`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: gameState.sessionId,
                        qid: gameState.currentQuestion.qid,
                        answer: gameState.selectedAnswer
                    })
                });

                const data = await response.json();
                const selected = document.querySelector(`.answer-option[data-answer="${gameState.selectedAnswer}"]`);

                if (data.correct) {
                    selected.classList.add('correct');
                    gameState.correctCount++;
                    updateProgress();

                    if (gameState.correctCount >= gameState.requiredCorrect) {
                        btn.textContent = 'üèÜ Ho√†n th√†nh!';
                        addChatMessage('üéâ Tuy·ªát v·ªùi! B·∫°n ƒë√£ ho√†n th√†nh t·∫•t c·∫£ c√°c c√¢u h·ªèi!');
                        setTimeout(() => finishGame(), 1500);
                    } else {
                        btn.textContent = '‚û°Ô∏è Ti·∫øp T·ª•c';
                        btn.disabled = false;
                        btn.classList.add('next-room');
                        btn.dataset.nextRoom = 'true';
                        addChatMessage('üéâ Tuy·ªát v·ªùi! ƒê√°p √°n ch√≠nh x√°c! B·∫°n ƒëang ti·∫øn g·∫ßn h∆°n ƒë·∫øn l·ªëi tho√°t!');
                    }
                } else {
                    selected.classList.add('wrong');
                    gameState.wrongCount++;
                    updateProgress();
                    showLockout('wrong', 'ƒê√°p √°n ch∆∞a ƒë√∫ng!');
                    
                    // G·ª£i √Ω t·ª´ chatbot
                    if (data.hint || data.gatekeeper) {
                        addChatMessage('üí° ' + (data.hint || data.gatekeeper));
                    } else {
                        addChatMessage('üí° H√£y suy nghƒ© l·∫°i nh√©! Xem x√©t k·ªπ t·ª´ng ƒë√°p √°n.');
                    }

                    setTimeout(() => {
                        document.querySelectorAll('.answer-option').forEach(o => {
                            o.classList.remove('selected', 'wrong', 'disabled');
                        });
                        gameState.selectedAnswer = null;
                        btn.textContent = 'X√°c Nh·∫≠n';
                        btn.disabled = true;
                        btn.dataset.nextRoom = 'false';
                    }, 10000);
                }
            } catch (error) {
                addChatMessage('C√≥ l·ªói x·∫£y ra khi ki·ªÉm tra ƒë√°p √°n. H√£y th·ª≠ l·∫°i! üîß');
                btn.textContent = 'X√°c Nh·∫≠n';
                btn.disabled = false;
                document.querySelectorAll('.answer-option').forEach(o => o.classList.remove('disabled'));
            }
        }

        function updateProgress() {
            document.getElementById('roomNumber').textContent = gameState.roomNumber;
            document.getElementById('correctCount').textContent = gameState.correctCount;
            document.getElementById('wrongCount').textContent = gameState.wrongCount;
            document.getElementById('progressFill').style.width = 
                (gameState.correctCount / gameState.requiredCorrect * 100) + '%';
        }

        function nextRoom() {
            document.getElementById('roomNumber').textContent = gameState.roomNumber;
            document.getElementById('questionArea').classList.remove('active');
            document.getElementById('cardsArea').style.display = 'block';

            const btn = document.getElementById('submitBtn');
            btn.textContent = 'X√°c Nh·∫≠n';
            btn.classList.remove('next-room');
            btn.dataset.nextRoom = 'false';
            btn.disabled = true;

            addChatMessage(`üö™ Ph√≤ng ${gameState.roomNumber}! H√£y l·∫≠t m·ªôt l√° b√†i m·ªõi nh√©!`);
            generateCards();
        }

        function resetToCards() {
            document.getElementById('loadingSpinner').classList.remove('active');
            document.getElementById('cardsArea').style.display = 'block';
            document.querySelectorAll('.card').forEach(c => {
                if (!c.classList.contains('flipped')) c.classList.remove('disabled');
            });
        }

        // Finish Game
        async function finishGame() {
            clearIntervals();

            const elapsedMs = Date.now() - gameState.startTime;
            const elapsedSeconds = Math.floor(elapsedMs / 1000);

            try {
                await fetch(`${API_BASE}/api/competition/finish`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        room_code: gameState.roomCode,
                        player_name: gameState.playerName,
                        correct: gameState.correctCount,
                        wrong: gameState.wrongCount,
                        time_ms: elapsedMs
                    })
                });

                showRankings();
            } catch (error) {
                showRankings();
            }
        }

        // Show Rankings
        async function showRankings() {
            showScreen('rankingsScreen');

            try {
                const response = await fetch(`${API_BASE}/api/competition/rankings/${gameState.roomCode}`);
                const data = await response.json();

                const podium = document.getElementById('podium');
                const order = [1, 0, 2]; // 2nd, 1st, 3rd
                podium.innerHTML = order.map(i => {
                    const p = data.rankings[i];
                    if (!p) return '';
                    return `
                        <div class="podium-place place-${i + 1}">
                            <div class="podium-avatar">${p.name.charAt(0).toUpperCase()}</div>
                            <div class="podium-name">${p.name}</div>
                            <div class="podium-stats">${p.correct} ƒë√∫ng - ${formatTimeMs(p.time_ms)}</div>
                            <div class="podium-block">${i + 1}</div>
                        </div>
                    `;
                }).join('');

                document.getElementById('fullRankings').innerHTML = data.rankings.map((p, i) => `
                    <div class="rank-item">
                        <div class="rank-number">#${i + 1}</div>
                        <span class="player-name">${p.name}</span>
                        <span class="rank-score">${p.correct} ƒë√∫ng</span>
                        <span class="rank-time">${formatTimeMs(p.time_ms)}</span>
                    </div>
                `).join('');
            } catch (error) {
                document.getElementById('fullRankings').innerHTML = '<p class="waiting-text">Kh√¥ng th·ªÉ t·∫£i b·∫£ng x·∫øp h·∫°ng</p>';
            }
        }

        function formatTimeMs(ms) {
            const totalSeconds = Math.floor(ms / 1000);
            const m = Math.floor(totalSeconds / 60);
            const s = totalSeconds % 60;
            const millis = Math.floor((ms % 1000) / 10);
            return `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}.${millis.toString().padStart(2, '0')}`;
        }

        // Init
        generateStars();

        // Check URL for join code
        const params = new URLSearchParams(window.location.search);
        const joinCode = params.get('join');
        if (joinCode) {
            document.getElementById('joinCodeInput').value = joinCode;
            showJoinRoom();
        }
    </script>
</body>
</html>

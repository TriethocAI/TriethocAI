<!doctype html>
<html lang="vi">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<title> Tri·∫øt h·ªçc AI </title>
		<link href="image/1.png" rel="icon" type="image/png">
		<style>
			:root {
				--bg: #0b1020;
				--card: rgba(255, 255, 255, 0.06);
				--border: rgba(255, 255, 255, 0.12);
				--text: rgba(255, 255, 255, 0.92);
				--muted: rgba(255, 255, 255, 0.7);
				--accent: #7c5cff;
				--user: rgba(124, 92, 255, 0.18);
				--assistant: rgba(255, 255, 255, 0.07);
			}

			* {
				box-sizing: border-box;
			}

			body {
				margin: 0;
				font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
				background: radial-gradient(1200px 700px at 10% 10%, rgba(124, 92, 255, 0.25), transparent 60%),
					radial-gradient(900px 600px at 90% 20%, rgba(0, 196, 255, 0.18), transparent 55%),
					var(--bg);
				color: var(--text);
			}

			.wrap {
				max-width: 980px;
				margin: 0 auto;
				padding: 22px 16px;
			}

			header {
				display: flex;
				gap: 15px;
				align-items: center;
				justify-content: flex-start;
				margin-bottom: 14px;
			}

			.header-logo {
				width: 45px;
				height: 45px;
				border-radius: 50%;
				object-fit: cover;
				border: 2px solid var(--accent);
			}

			h1 {
				margin: 0;
				font-size: 18px;
				letter-spacing: 0.2px;
			}

			.hint {
				font-size: 12px;
				color: var(--muted);
			}

			.grid {
				display: grid;
				grid-template-columns: 1fr;
				gap: 12px;
			}

			.panel {
				background: var(--card);
				border: 1px solid var(--border);
				border-radius: 14px;
				overflow: hidden;
				backdrop-filter: blur(10px);
			}

			.topbar {
				display: flex;
				gap: 10px;
				align-items: center;
				padding: 12px;
				border-bottom: 1px solid var(--border);
			}

			.nav-btn {
				margin-left: auto;
				padding: 8px 16px;
				border-radius: 20px;
				background: linear-gradient(135deg, rgba(240, 147, 251, 0.8), rgba(245, 87, 108, 0.8));
				color: white;
				text-decoration: none;
				font-size: 14px;
				font-weight: 600;
				transition: transform 0.2s, box-shadow 0.2s;
			}

			.nav-btn:hover {
				transform: translateY(-2px);
				box-shadow: 0 4px 15px rgba(245, 87, 108, 0.4);
			}

			label {
				font-size: 12px;
				color: var(--muted);
			}

			input[type="text"] {
				width: 100%;
				padding: 10px 12px;
				border-radius: 10px;
				border: 1px solid var(--border);
				background: rgba(0, 0, 0, 0.25);
				color: var(--text);
				outline: none;
			}

			.chat {
				height: min(66vh, 680px);
				overflow: auto;
				padding: 14px;
			}

			.msg {
				display: flex;
				gap: 12px;
				align-items: flex-start;
				max-width: 450px;
				padding: 10px 12px;
				border-radius: 12px;
				border: 1px solid var(--border);
				margin: 10px 0;
				line-height: 1.45;
			}

			.msg-avatar {
				width: 36px;
				height: 36px;
				border-radius: 50%;
				object-fit: cover;
				flex-shrink: 0;
				margin-top: 2px;
			}

			.msg-content {
				flex: 1;
				white-space: pre-wrap;
			}

			.msg.user {
				margin-left: auto;
				background: var(--user);
				flex-direction: row-reverse;
			}

			.msg.assistant {
				margin-right: auto;
				background: var(--assistant);
			}

			.composer {
				display: flex;
				gap: 10px;
				padding: 12px;
				border-top: 1px solid var(--border);
			}

			textarea {
				flex: 1;
				min-height: 44px;
				max-height: 140px;
				resize: vertical;
				padding: 10px 12px;
				border-radius: 12px;
				border: 1px solid var(--border);
				background: rgba(0, 0, 0, 0.25);
				color: var(--text);
				outline: none;
			}

			button {
				padding: 10px 14px;
				border-radius: 12px;
				border: 1px solid var(--border);
				background: linear-gradient(135deg, rgba(124, 92, 255, 0.9), rgba(0, 196, 255, 0.45));
				color: white;
				cursor: pointer;
				min-width: 120px;
				font-weight: 600;
			}

			button:disabled {
				opacity: 0.55;
				cursor: not-allowed;
			}

			.footer {
				padding: 10px 12px;
				font-size: 12px;
				color: var(--muted);
			}

			/* ·∫®n c√°c ph·∫ßn kh√¥ng c·∫ßn thi·∫øt */
			.topbar {
				display: none !important;
			}

			header .hint {
				display: none !important;
			}

			/* Intro Screen */
			.intro-screen {
				position: fixed;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				background: radial-gradient(circle at 50% 50%, rgba(124, 92, 255, 0.3), transparent 50%),
					radial-gradient(circle at 30% 70%, rgba(0, 196, 255, 0.2), transparent 40%),
					var(--bg);
				display: flex;
				flex-direction: column;
				justify-content: center;
				align-items: center;
				z-index: 9999;
				transition: opacity 0.8s ease, visibility 0.8s ease;
			}

			.intro-screen.hidden {
				opacity: 0;
				visibility: hidden;
			}

			.intro-avatar {
				width: 120px;
				height: 120px;
				border-radius: 50%;
				border: 4px solid var(--accent);
				box-shadow: 0 0 60px rgba(124, 92, 255, 0.6),
					0 0 100px rgba(124, 92, 255, 0.3);
				animation: introFloat 2s ease-in-out infinite, introGlow 2s ease-in-out infinite;
				margin-bottom: 30px;
			}

			@keyframes introFloat {
				0%, 100% { transform: translateY(0); }
				50% { transform: translateY(-15px); }
			}

			@keyframes introGlow {
				0%, 100% { box-shadow: 0 0 60px rgba(124, 92, 255, 0.6), 0 0 100px rgba(124, 92, 255, 0.3); }
				50% { box-shadow: 0 0 80px rgba(124, 92, 255, 0.8), 0 0 120px rgba(124, 92, 255, 0.5); }
			}

			.intro-text {
				font-size: 28px;
				font-weight: 700;
				color: white;
				text-align: center;
				opacity: 0;
				animation: introFadeIn 1s ease forwards 0.5s;
				text-shadow: 0 0 20px rgba(124, 92, 255, 0.8);
			}

			.intro-subtext {
				font-size: 16px;
				color: var(--muted);
				margin-top: 12px;
				opacity: 0;
				animation: introFadeIn 1s ease forwards 1s;
			}

			@keyframes introFadeIn {
				from { opacity: 0; transform: translateY(20px); }
				to { opacity: 1; transform: translateY(0); }
			}

			.intro-loader {
				margin-top: 40px;
				display: flex;
				gap: 8px;
				opacity: 0;
				animation: introFadeIn 1s ease forwards 1.5s;
			}

			.intro-loader span {
				width: 12px;
				height: 12px;
				background: var(--accent);
				border-radius: 50%;
				animation: introBounce 1.4s ease-in-out infinite;
			}

			.intro-loader span:nth-child(1) { animation-delay: 0s; }
			.intro-loader span:nth-child(2) { animation-delay: 0.2s; }
			.intro-loader span:nth-child(3) { animation-delay: 0.4s; }

			@keyframes introBounce {
				0%, 80%, 100% { transform: scale(0.6); opacity: 0.5; }
				40% { transform: scale(1); opacity: 1; }
			}

			/* Main content hidden initially */
			.wrap {
				opacity: 0;
				transition: opacity 0.5s ease;
			}

			.wrap.visible {
				opacity: 1;
			}
		</style>
	</head>
	<body>
		<!-- Intro Screen -->
		<div class="intro-screen" id="introScreen">
			<img src="image/logochatbotmln.png" alt="Tri·∫øt h·ªçc AI" class="intro-avatar" onerror="this.src='image/1.png'">
			<div class="intro-text">Ch√†o m·ª´ng ƒë·∫øn v·ªõi Tri·∫øt h·ªçc AI</div>
			<div class="intro-subtext">Kh√°m ph√° tri·∫øt h·ªçc M√°c-L√™nin c√πng tr√≠ tu·ªá nh√¢n t·∫°o</div>
			<div class="intro-loader">
				<span></span>
				<span></span>
				<span></span>
			</div>
		</div>

		<div class="wrap" id="mainContent">
			<header>
				<img src="image/logochatbotmln.png" alt="Logo" class="header-logo" onerror="this.style.display='none'">
				<h1>Tri·∫øt h·ªçc AI</h1>
				<a href="maze-game.html" class="nav-btn" title="Ch∆°i game M√™ Cung Tri·∫øt H·ªçc">üèõÔ∏è M√™ Cung</a>
				<a href="maze-competition.html" class="nav-btn" title="Thi ƒë·∫•u c√πng b·∫°n b√®" style="background: linear-gradient(135deg, #fbbf24, #f59e0b); color: #1a0a2e;">üèÜ Thi ƒê·∫•u</a>
				<div class="hint">Backend: <code>POST /api/search</code> (m·∫∑c ƒë·ªãnh <code>http://127.0.0.1:5002/api/search</code>)</div>
			</header>

			<div class="grid">
				<div class="panel">
					<div class="topbar">
						<div style="min-width: 180px">
							<label for="endpoint">Backend URL</label>
							<input id="endpoint" type="text" value="http://127.0.0.1:5002/api/search" />
						</div>
						<div style="min-width: 200px">
							<label for="stream">Streaming</label>
							<div style="display:flex; gap:8px; align-items:center; margin-top:6px;">
								<input id="stream" type="checkbox" checked />
								<span class="hint">Hi·ªán ch·ªØ ngay (SSE)</span>
							</div>
						</div>
						<div class="hint">
							N·∫øu b·∫°n m·ªü file n√†y tr·ª±c ti·∫øp (file://), CORS c√≥ th·ªÉ ch·∫∑n. C√°ch ·ªïn nh·∫•t l√† m·ªü qua m·ªôt web server (m√¨nh ghi b√™n d∆∞·ªõi).
						</div>
					</div>

					<div id="chat" class="chat"></div>

					<div class="composer">
						<textarea id="input" placeholder="Nh·∫≠p c√¢u h·ªèi v·ªÅ tri·∫øt h·ªçc‚Ä¶ (Enter ƒë·ªÉ g·ª≠i, Shift+Enter xu·ªëng d√≤ng)"></textarea>
						<button id="send">G·ª≠i</button>
					</div>

					<div class="footer">
						G·ª£i √Ω: "Tri·∫øt h·ªçc l√† g√¨?", "Ba quy lu·∫≠t c∆° b·∫£n c·ªßa ph√©p bi·ªán ch·ª©ng l√† g√¨?", ‚Ä¶
					</div>
				</div>
			</div>
		</div>

		<script>
			const $ = (id) => document.getElementById(id);
			const chatEl = $("chat");
			const inputEl = $("input");
			const endpointEl = $("endpoint");
			const streamEl = $("stream");
			const sendBtn = $("send");

			/** @type {{role:'user'|'assistant', content:string}[]} */
			const messages = [];

			function append(role, content) {
				const div = document.createElement("div");
				div.className = `msg ${role}`;
				
				// T·∫°o avatar
				const avatar = document.createElement("img");
				avatar.className = "msg-avatar";
				if (role === "user") {
					avatar.src = "image/user.png";
					avatar.alt = "User";
				} else {
					avatar.src = "image/logochatbotmln.png";
					avatar.alt = "Chatbot";
				}
				avatar.onerror = function() { this.style.display = 'none'; };
				
				// T·∫°o n·ªôi dung
				const contentDiv = document.createElement("div");
				contentDiv.className = "msg-content";
				contentDiv.textContent = content;
				
				div.appendChild(avatar);
				div.appendChild(contentDiv);
				chatEl.appendChild(div);
				chatEl.scrollTop = chatEl.scrollHeight;
				
				return contentDiv; // Tr·∫£ v·ªÅ contentDiv ƒë·ªÉ c√≥ th·ªÉ c·∫≠p nh·∫≠t trong streaming
			}

			async function send() {
				const text = inputEl.value.trim();
				if (!text) return;

				messages.push({ role: "user", content: text });
				append("user", text);
				inputEl.value = "";

				sendBtn.disabled = true;
				const url = endpointEl.value.trim();

				try {
					const useStream = !!streamEl.checked;
					if (!useStream) {
						const res = await fetch(url, {
							method: "POST",
							headers: { "Content-Type": "application/json" },
							body: JSON.stringify(messages),
						});

						if (!res.ok) {
							const t = await res.text();
							append(
								"assistant",
								`L·ªói HTTP ${res.status}.\nB·∫°n ƒëang g·ªçi: ${url}\n\nChi ti·∫øt: ${t.slice(0, 500)}`
							);
							return;
						}

						const data = await res.json();
						const content = data?.content ?? "(Kh√¥ng c√≥ content trong response)";
						messages.push({ role: "assistant", content });
						append("assistant", content);
						return;
					}

						// Streaming mode (SSE)
						// Accept a few common inputs:
						// - http://127.0.0.1:5002/api/search  -> /api/search/stream
						// - http://127.0.0.1:5002           -> /api/search/stream
						// - http://127.0.0.1:5002/api/search/stream -> as-is
						let streamUrl = url;
						if (streamUrl.endsWith("/api/search")) {
							streamUrl = streamUrl + "/stream";
						} else if (!streamUrl.endsWith("/api/search/stream")) {
							streamUrl = streamUrl.replace(/\/+$/, "") + "/api/search/stream";
						}
					
					// T·∫°o message v·ªõi avatar cho assistant
					const assistantDiv = document.createElement("div");
					assistantDiv.className = "msg assistant";
					
					const avatar = document.createElement("img");
					avatar.className = "msg-avatar";
					avatar.src = "image/logochatbotmln.png";
					avatar.alt = "Chatbot";
					avatar.onerror = function() { this.style.display = 'none'; };
					
					const contentDiv = document.createElement("div");
					contentDiv.className = "msg-content";
					contentDiv.textContent = "(ƒêang x·ª≠ l√Ω‚Ä¶)";
					
					assistantDiv.appendChild(avatar);
					assistantDiv.appendChild(contentDiv);
					chatEl.appendChild(assistantDiv);
					chatEl.scrollTop = chatEl.scrollHeight;

					const res = await fetch(streamUrl, {
						method: "POST",
						headers: { "Content-Type": "application/json" },
						body: JSON.stringify(messages),
					});

					if (!res.ok || !res.body) {
						const t = await res.text();
						contentDiv.textContent = `L·ªói HTTP ${res.status}.\nB·∫°n ƒëang g·ªçi: ${streamUrl}\n\nChi ti·∫øt: ${t.slice(0, 500)}`;
						return;
					}

					const reader = res.body.getReader();
					const decoder = new TextDecoder("utf-8");
					let buffer = "";
					let finalText = "";
					let startedStreamingText = false;

					while (true) {
						const { value, done } = await reader.read();
						if (done) break;
						buffer += decoder.decode(value, { stream: true });

						// SSE frames are separated by double newline
						let idx;
						while ((idx = buffer.indexOf("\n\n")) !== -1) {
							const frame = buffer.slice(0, idx);
							buffer = buffer.slice(idx + 2);

							let event = "message";
							let dataLine = "";
							for (const line of frame.split("\n")) {
								if (line.startsWith("event:")) event = line.slice(6).trim();
								if (line.startsWith("data:")) dataLine += line.slice(5).trim();
							}
							const dataText = dataLine.replace(/\\n/g, "\n");

							if (event === "status") {
								if (!startedStreamingText) contentDiv.textContent = `(ƒêang ${dataText}‚Ä¶)`;
							} else if (event === "chunk") {
								if (!startedStreamingText) {
									contentDiv.textContent = "";
									startedStreamingText = true;
								}
								contentDiv.textContent += dataText;
							} else if (event === "final") {
								finalText = dataText;
								contentDiv.textContent = finalText;
							} else if (event === "error") {
								contentDiv.textContent = `L·ªói: ${dataText}`;
							}
							chatEl.scrollTop = chatEl.scrollHeight;
						}
					}

					if (finalText) {
						messages.push({ role: "assistant", content: finalText });
					} else {
						messages.push({ role: "assistant", content: contentDiv.textContent });
					}
				} catch (e) {
					const isFile = window.location.protocol === "file:";
					append(
						"assistant",
						[
							"Kh√¥ng g·ªçi ƒë∆∞·ª£c backend.",
							"",
							"- Backend ƒë√£ ch·∫°y ch∆∞a? (m·ªü http://127.0.0.1:5002/ ph·∫£i th·∫•y status ok)",
							"- URL ƒë√∫ng ch∆∞a? (m·∫∑c ƒë·ªãnh: http://127.0.0.1:5002/api/search)",
							isFile
								? "- B·∫°n ƒëang m·ªü UI b·∫±ng file:// n√™n tr√¨nh duy·ªát c√≥ th·ªÉ ch·∫∑n fetch. H√£y m·ªü UI qua web server: python -m http.server 3000 r·ªìi v√†o http://127.0.0.1:3000/index.html"
								: "- N·∫øu UI v√† backend kh√°c port/domain, c√≥ th·ªÉ b·ªã CORS.",
							"",
							`Chi ti·∫øt: ${e}`,
						].join("\n")
					);
				} finally {
					sendBtn.disabled = false;
				}
			}

			sendBtn.addEventListener("click", send);
			inputEl.addEventListener("keydown", (ev) => {
				if (ev.key === "Enter" && !ev.shiftKey) {
					ev.preventDefault();
					send();
				}
			});

			// Intro animation - hide after 3 seconds
			setTimeout(() => {
				const introScreen = document.getElementById('introScreen');
				const mainContent = document.getElementById('mainContent');
				
				introScreen.classList.add('hidden');
				mainContent.classList.add('visible');
				
				// Remove intro from DOM after transition
				setTimeout(() => {
					introScreen.remove();
				}, 800);
				
				// greeting after intro
				append(
					"assistant",
					"Xin ch√†o! M√¨nh l√† Tri·∫øt h·ªçc AI. H√£y ƒë·∫∑t c√¢u h·ªèi v·ªÅ Tri·∫øt h·ªçc M√°c-L√™nin nh√©."
				);
			}, 3000);
		</script>
	</body>
</html>